# æ— é™å¾ªç¯é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š
- æ‰“å¼€è´­ç‰©è½¦é¡µé¢
- æ§åˆ¶å°æ—¥å¿—ä¸€ç›´é‡å¤ï¼š
  - "ç”¨æˆ·å·²ç™»å½•ï¼Œæ‰§è¡Œå›è°ƒ"
  - "requireLoginä»€ä¹ˆä»€ä¹ˆçš„"
- æ— é™å¾ªç¯ï¼Œé¡µé¢å¡æ­»

## ğŸ” é—®é¢˜æ ¹å› 

### ä»£ç åˆ†æ

**cart.js çš„ onLoad æ–¹æ³•**ï¼š
```javascript
onLoad() {
  // âŒ é—®é¢˜ä»£ç 
  if (!app.requireLogin(() => {
    this.onLoad();  // â† é€’å½’è°ƒç”¨ï¼
  })) {
    return;
  }
  this.loadCart();
}
```

### æ‰§è¡Œæµç¨‹

```
ç”¨æˆ·æ‰“å¼€è´­ç‰©è½¦
  â†“
onLoad() è¢«è°ƒç”¨
  â†“
è°ƒç”¨ app.requireLogin(callback)
  â†“
ç”¨æˆ·å·²ç™»å½•ï¼Œç«‹å³æ‰§è¡Œ callback
  â†“
callback ä¸­è°ƒç”¨ this.onLoad()
  â†“
onLoad() åˆè°ƒç”¨ app.requireLogin(callback)
  â†“
callback åˆè°ƒç”¨ this.onLoad()
  â†“
â™»ï¸ æ— é™å¾ªç¯ï¼
```

### ä¸ºä»€ä¹ˆä¼šå¾ªç¯ï¼Ÿ

`app.requireLogin()` çš„é€»è¾‘ï¼š
```javascript
requireLogin(callback) {
  if (this.checkLogin()) {
    // å·²ç™»å½•ï¼Œç«‹å³æ‰§è¡Œå›è°ƒ
    callback();  // â† è¿™é‡Œæ‰§è¡Œå›è°ƒ
    return true;
  } else {
    // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æç¤º
    wx.showModal({ ... });
    return false;
  }
}
```

å½“ç”¨æˆ·å·²ç™»å½•æ—¶ï¼Œ`callback()` ä¼š**ç«‹å³æ‰§è¡Œ**ï¼Œè€Œ callback ä¸­åˆè°ƒç”¨äº† `onLoad()`ï¼Œå½¢æˆé€’å½’ã€‚

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

**ä¸è¦åœ¨ requireLogin çš„å›è°ƒä¸­è°ƒç”¨è‡ªèº«**

1. ç›´æ¥æ£€æŸ¥ç™»å½•çŠ¶æ€
2. æœªç™»å½•æ—¶æ˜¾ç¤ºæç¤º
3. å·²ç™»å½•æ—¶ç›´æ¥åŠ è½½æ•°æ®

### ä¿®å¤ä»£ç 

#### cart.js ä¿®å¤

**ä¿®å¤å‰** âŒï¼š
```javascript
onLoad() {
  // é€’å½’è°ƒç”¨å¯¼è‡´æ— é™å¾ªç¯
  if (!app.requireLogin(() => {
    this.onLoad();  // âŒ
  })) {
    return;
  }
  this.loadCart();
}

onShow() {
  const userInfo = app.globalData.userInfo || wx.getStorageSync('userInfo');
  if (!userInfo || !userInfo.userId) {  // âŒ é”™è¯¯çš„å­—æ®µ
    return;
  }
  this.loadCart();
}
```

**ä¿®å¤å** âœ…ï¼š
```javascript
onLoad() {
  // ç›´æ¥æ£€æŸ¥ç™»å½•çŠ¶æ€
  const userInfo = app.globalData.userInfo || wx.getStorageSync('userInfo');
  if (!userInfo || !userInfo.nickName) {
    // æ˜¾ç¤ºæç¤ºå¹¶è·³è½¬
    wx.showModal({
      title: 'éœ€è¦ç™»å½•',
      content: 'æŸ¥çœ‹è´­ç‰©è½¦éœ€è¦å…ˆç™»å½•',
      confirmText: 'å»ç™»å½•',
      cancelText: 'è¿”å›',
      success: (res) => {
        if (res.confirm) {
          wx.switchTab({
            url: '/pages/profile/profile'
          });
        } else {
          wx.navigateBack();
        }
      }
    });
    return;
  }
  
  // å·²ç™»å½•ï¼ŒåŠ è½½æ•°æ®
  this.loadCart();
}

onShow() {
  const userInfo = app.globalData.userInfo || wx.getStorageSync('userInfo');
  if (!userInfo || !userInfo.nickName) {  // âœ… æ­£ç¡®çš„å­—æ®µ
    return;
  }
  this.loadCart();
}
```

#### order/list/list.js ä¿®å¤

åŒæ ·çš„ä¿®å¤æ–¹å¼ï¼š
```javascript
onLoad() {
  // ç›´æ¥æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œä¸ä½¿ç”¨é€’å½’å›è°ƒ
  const userInfo = app.globalData.userInfo || wx.getStorageSync('userInfo');
  if (!userInfo || !userInfo.nickName) {
    wx.showModal({
      title: 'éœ€è¦ç™»å½•',
      content: 'æŸ¥çœ‹è®¢å•éœ€è¦å…ˆç™»å½•',
      confirmText: 'å»ç™»å½•',
      cancelText: 'è¿”å›',
      success: (res) => {
        if (res.confirm) {
          wx.switchTab({
            url: '/pages/profile/profile'
          });
        } else {
          wx.navigateBack();
        }
      }
    });
    return;
  }
  
  this.setData({ isAdmin: app.checkIsAdmin() });
  this.loadOrders();
}
```

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ âŒ

```
ç”¨æˆ·æ‰“å¼€è´­ç‰©è½¦
  â†“
onLoad()
  â†“
requireLogin(callback)
  â†“
ç”¨æˆ·å·²ç™»å½• â†’ callback()
  â†“
callback è°ƒç”¨ onLoad()
  â†“
onLoad() è°ƒç”¨ requireLogin()
  â†“
callback() è°ƒç”¨ onLoad()
  â†“
â™»ï¸ æ— é™å¾ªç¯
  â†“
æ§åˆ¶å°æ—¥å¿—é‡å¤è¾“å‡º
é¡µé¢å¡æ­»
```

### ä¿®å¤å âœ…

```
ç”¨æˆ·æ‰“å¼€è´­ç‰©è½¦
  â†“
onLoad()
  â†“
æ£€æŸ¥ userInfo.nickName
  â†“
  å·²ç™»å½•ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ loadCart() â†’ æ˜¾ç¤ºè´­ç‰©è½¦ âœ…
    â””â”€ å¦ â†’ æ˜¾ç¤ºç™»å½•æç¤º â†’ è·³è½¬ç™»å½•
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ç¼–è¯‘
```
1. å¾®ä¿¡å¼€å‘è€…å·¥å…· â†’ å·¥å…· â†’ æ¸…é™¤ â†’ å…¨éƒ¨æ¸…é™¤
2. ç‚¹å‡»"ç¼–è¯‘"æŒ‰é’®
```

### æ­¥éª¤ 2ï¼šæµ‹è¯•åœºæ™¯

#### æµ‹è¯• Aï¼šå·²ç™»å½•çŠ¶æ€æ‰“å¼€è´­ç‰©è½¦

1. å…ˆç™»å½•ï¼ˆç‚¹å‡»"æˆ‘çš„" â†’ "ç«‹å³ç™»å½•"ï¼‰
2. æ·»åŠ ä¸€äº›èœå“åˆ°è´­ç‰©è½¦
3. ç‚¹å‡»è´­ç‰©è½¦å›¾æ ‡
4. **âœ… åº”è¯¥æ­£å¸¸æ˜¾ç¤ºè´­ç‰©è½¦**
5. **âœ… æ§åˆ¶å°æ— é‡å¤æ—¥å¿—**
6. **âœ… é¡µé¢ä¸å¡æ­»**

#### æµ‹è¯• Bï¼šæœªç™»å½•çŠ¶æ€æ‰“å¼€è´­ç‰©è½¦

1. æ¸…é™¤ç¼“å­˜ï¼ˆé€€å‡ºç™»å½•ï¼‰
2. å°è¯•æ‰“å¼€è´­ç‰©è½¦
3. **âœ… åº”è¯¥æ˜¾ç¤º"éœ€è¦ç™»å½•"æç¤º**
4. ç‚¹å‡»"å»ç™»å½•"
5. **âœ… è·³è½¬åˆ°"æˆ‘çš„"é¡µé¢**
6. ç™»å½•åæ‰‹åŠ¨è¿”å›è´­ç‰©è½¦
7. **âœ… æ­£å¸¸æ˜¾ç¤º**

#### æµ‹è¯• Cï¼šè®¢å•åˆ—è¡¨

1. å·²ç™»å½•çŠ¶æ€
2. ç‚¹å‡»"è®¢å•"æ ‡ç­¾
3. **âœ… æ­£å¸¸æ˜¾ç¤ºè®¢å•åˆ—è¡¨**
4. **âœ… æ§åˆ¶å°æ— é‡å¤æ—¥å¿—**

### æ­¥éª¤ 3ï¼šéªŒè¯æ§åˆ¶å°æ—¥å¿—

**âœ… æ­£ç¡®çš„æ—¥å¿—ï¼ˆåªå‡ºç°ä¸€æ¬¡ï¼‰**ï¼š
```
ç”¨æˆ·å·²ç™»å½•ï¼Œæ‰§è¡Œå›è°ƒ
ç®¡ç†å‘˜æ£€æŸ¥: xxx æ˜¯å¦æ˜¯ç®¡ç†å‘˜: true
```

**âŒ ä¸åº”è¯¥çœ‹åˆ°**ï¼š
```
ç”¨æˆ·å·²ç™»å½•ï¼Œæ‰§è¡Œå›è°ƒ
requireLoginè¢«è°ƒç”¨
ç”¨æˆ·å·²ç™»å½•ï¼Œæ‰§è¡Œå›è°ƒ
requireLoginè¢«è°ƒç”¨
ç”¨æˆ·å·²ç™»å½•ï¼Œæ‰§è¡Œå›è°ƒ
... (æ— é™é‡å¤)
```

## ğŸ“ é¢„æœŸç»“æœ

**âœ… æˆåŠŸçš„æ ‡å¿—**ï¼š

1. **è´­ç‰©è½¦é¡µé¢**ï¼š
   - æ­£å¸¸åŠ è½½
   - æ˜¾ç¤ºè´­ç‰©è½¦å†…å®¹
   - æ— å¾ªç¯æ—¥å¿—

2. **è®¢å•åˆ—è¡¨é¡µé¢**ï¼š
   - æ­£å¸¸åŠ è½½
   - æ˜¾ç¤ºè®¢å•åˆ—è¡¨
   - æ— å¾ªç¯æ—¥å¿—

3. **æ§åˆ¶å°**ï¼š
   - æ—¥å¿—æ¸…æ™°ï¼Œä¸é‡å¤
   - æ— æ— é™å¾ªç¯
   - æ— é”™è¯¯ä¿¡æ¯

4. **ç”¨æˆ·ä½“éªŒ**ï¼š
   - é¡µé¢å“åº”å¿«é€Ÿ
   - ä¸å¡é¡¿
   - åŠŸèƒ½æ­£å¸¸

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹

### 1. é¿å…é€’å½’å›è°ƒ

**âŒ é”™è¯¯æ¨¡å¼**ï¼š
```javascript
onLoad() {
  someAsyncFunction(() => {
    this.onLoad();  // é€’å½’è°ƒç”¨è‡ªå·±
  });
}
```

**âœ… æ­£ç¡®æ¨¡å¼**ï¼š
```javascript
onLoad() {
  // ç›´æ¥æ‰§è¡Œé€»è¾‘ï¼Œä¸é€’å½’
  this.loadData();
}
```

### 2. ç™»å½•æ£€æŸ¥çš„æ­£ç¡®æ–¹å¼

**æ–¹æ¡ˆ 1ï¼šç›´æ¥æ£€æŸ¥**ï¼ˆæ¨èï¼‰
```javascript
onLoad() {
  const userInfo = app.globalData.userInfo || wx.getStorageSync('userInfo');
  if (!userInfo || !userInfo.nickName) {
    // æ˜¾ç¤ºæç¤º
    wx.showModal({ ... });
    return;
  }
  // ç»§ç»­æ‰§è¡Œ
  this.loadData();
}
```

**æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ requireLogin**ï¼ˆå¦‚æœå¿…é¡»ï¼‰
```javascript
onLoad() {
  // ä¸è¦åœ¨å›è°ƒä¸­è°ƒç”¨ onLoad
  app.requireLogin(() => {
    // åªåšç®€å•çš„æ•°æ®åŠ è½½
    this.loadData();  // âœ… ä¸æ˜¯ this.onLoad()
  });
}
```

### 3. å­—æ®µåç§°ä¸€è‡´æ€§

ç¡®ä¿æ£€æŸ¥çš„å­—æ®µåç§°æ­£ç¡®ï¼š
```javascript
// âŒ é”™è¯¯ï¼šç°åœ¨ä¸ç”¨ userId
if (!userInfo.userId) { ... }

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ nickName
if (!userInfo.nickName) { ... }
```

### 4. onShow çš„å¹‚ç­‰æ€§

`onShow` ä¼šè¢«å¤šæ¬¡è°ƒç”¨ï¼Œç¡®ä¿å®ƒæ˜¯å¹‚ç­‰çš„ï¼š
```javascript
onShow() {
  // ç®€å•æ£€æŸ¥ï¼Œä¸è§¦å‘å¤æ‚é€»è¾‘
  if (!this.checkLogin()) {
    return;
  }
  
  // åªåŠ è½½æ•°æ®ï¼Œä¸æ”¹å˜çŠ¶æ€
  this.loadData();
}
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ç™»å½•æ£€æŸ¥æ¨¡å¼

```javascript
// é¡µé¢çº§ç™»å½•æ£€æŸ¥
Page({
  onLoad() {
    // 1. æ£€æŸ¥ç™»å½•
    if (!this.checkLogin()) {
      this.handleNotLogin();
      return;
    }
    
    // 2. å·²ç™»å½•ï¼Œåˆå§‹åŒ–
    this.init();
  },
  
  checkLogin() {
    const userInfo = app.globalData.userInfo || wx.getStorageSync('userInfo');
    return !!(userInfo && userInfo.nickName);
  },
  
  handleNotLogin() {
    wx.showModal({
      title: 'éœ€è¦ç™»å½•',
      content: 'è¯·å…ˆç™»å½•',
      success: (res) => {
        if (res.confirm) {
          wx.switchTab({ url: '/pages/profile/profile' });
        } else {
          wx.navigateBack();
        }
      }
    });
  },
  
  init() {
    // åˆå§‹åŒ–é€»è¾‘
    this.loadData();
  }
});
```

### 2. é¿å…å¾ªç¯çš„è®¾è®¡åŸåˆ™

**åŸåˆ™ 1ï¼šå›è°ƒä¸è°ƒç”¨è§¦å‘è€…**
```javascript
// âŒ é”™è¯¯
function a() {
  b(() => a());  // å›è°ƒä¸­è°ƒç”¨è‡ªå·±
}

// âœ… æ­£ç¡®
function a() {
  b(() => c());  // å›è°ƒä¸­è°ƒç”¨å…¶ä»–å‡½æ•°
}
```

**åŸåˆ™ 2ï¼šæ˜ç¡®æ‰§è¡Œæµç¨‹**
```
onLoad â†’ check â†’ load â†’ done
ï¼ˆä¸è¦å¾ªç¯å› onLoadï¼‰
```

**åŸåˆ™ 3ï¼šä½¿ç”¨çŠ¶æ€æ ‡è®°**
```javascript
onLoad() {
  if (this._loaded) return;  // é˜²æ­¢é‡å¤åŠ è½½
  this._loaded = true;
  this.loadData();
}
```

### 3. è°ƒè¯•æ— é™å¾ªç¯

**æ–¹æ³• 1ï¼šæ·»åŠ è®¡æ•°å™¨**
```javascript
let callCount = 0;
onLoad() {
  callCount++;
  console.log('onLoad è°ƒç”¨æ¬¡æ•°:', callCount);
  if (callCount > 5) {
    console.error('æ£€æµ‹åˆ°æ— é™å¾ªç¯ï¼');
    return;
  }
  // ...
}
```

**æ–¹æ³• 2ï¼šæ·»åŠ å †æ ˆè¿½è¸ª**
```javascript
onLoad() {
  console.trace('onLoad è°ƒç”¨å †æ ˆ');
  // ...
}
```

**æ–¹æ³• 3ï¼šä½¿ç”¨æ–­ç‚¹**
- åœ¨é€’å½’è°ƒç”¨çš„åœ°æ–¹è®¾ç½®æ–­ç‚¹
- æŸ¥çœ‹è°ƒç”¨å †æ ˆ
- åˆ†æå¾ªç¯åŸå› 

## ğŸš€ æ‰©å±•ä¼˜åŒ–

### 1. ç»Ÿä¸€çš„ç™»å½•æ£€æŸ¥ä¸­é—´ä»¶

åˆ›å»ºä¸€ä¸ªé€šç”¨çš„ç™»å½•æ£€æŸ¥å·¥å…·ï¼š

```javascript
// utils/auth.js
const authMiddleware = {
  // æ£€æŸ¥ç™»å½•
  checkLogin() {
    const app = getApp();
    const userInfo = app.globalData.userInfo || wx.getStorageSync('userInfo');
    return !!(userInfo && userInfo.nickName);
  },
  
  // è¦æ±‚ç™»å½•
  requireLogin(options = {}) {
    if (this.checkLogin()) {
      return true;
    }
    
    wx.showModal({
      title: options.title || 'éœ€è¦ç™»å½•',
      content: options.content || 'è¯·å…ˆç™»å½•',
      confirmText: 'å»ç™»å½•',
      cancelText: options.showCancel ? 'å–æ¶ˆ' : 'è¿”å›',
      success: (res) => {
        if (res.confirm) {
          wx.switchTab({ url: '/pages/profile/profile' });
        } else if (options.onCancel) {
          options.onCancel();
        } else {
          wx.navigateBack();
        }
      }
    });
    
    return false;
  }
};

module.exports = authMiddleware;
```

ä½¿ç”¨ï¼š
```javascript
const auth = require('../../utils/auth.js');

Page({
  onLoad() {
    if (!auth.requireLogin({
      title: 'æŸ¥çœ‹è´­ç‰©è½¦',
      content: 'æŸ¥çœ‹è´­ç‰©è½¦éœ€è¦å…ˆç™»å½•'
    })) {
      return;
    }
    
    this.loadCart();
  }
});
```

### 2. é¡µé¢åŸºç±»

```javascript
// åˆ›å»ºä¸€ä¸ªåŸºç±»å¤„ç†é€šç”¨é€»è¾‘
class BasePage {
  constructor(options) {
    this.requiresAuth = options.requiresAuth || false;
    
    const originalOnLoad = options.onLoad;
    options.onLoad = function() {
      if (this.requiresAuth && !this.checkLogin()) {
        this.handleNotLogin();
        return;
      }
      if (originalOnLoad) {
        originalOnLoad.call(this);
      }
    };
    
    return options;
  }
  
  checkLogin() {
    // ç™»å½•æ£€æŸ¥é€»è¾‘
  }
  
  handleNotLogin() {
    // æœªç™»å½•å¤„ç†é€»è¾‘
  }
}
```

## âœ¨ æ€»ç»“

**é—®é¢˜åŸå› **ï¼š
- requireLogin å›è°ƒä¸­é€’å½’è°ƒç”¨ onLoad
- å¯¼è‡´æ— é™å¾ªç¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç›´æ¥æ£€æŸ¥ç™»å½•çŠ¶æ€
- ä¸ä½¿ç”¨é€’å½’å›è°ƒ
- ä½¿ç”¨æ­£ç¡®çš„å­—æ®µåï¼ˆnickNameï¼‰

**ä¿®å¤æ•ˆæœ**ï¼š
- âœ… æ— æ— é™å¾ªç¯
- âœ… æ—¥å¿—æ¸…æ™°
- âœ… é¡µé¢æ­£å¸¸åŠ è½½
- âœ… ç”¨æˆ·ä½“éªŒæµç•…

**æ¶‰åŠæ–‡ä»¶**ï¼š
- pages/cart/cart.js
- pages/order/list/list.js

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2026-01-18  
**ä¿®å¤æ–¹æ³•**ï¼šç§»é™¤é€’å½’å›è°ƒï¼Œç›´æ¥æ£€æŸ¥ç™»å½•çŠ¶æ€  
**æµ‹è¯•çŠ¶æ€**ï¼šå¾…éªŒè¯
