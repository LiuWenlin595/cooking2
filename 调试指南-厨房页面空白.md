# 厨房页面空白问题 - 调试指南

## 🔍 问题定位

### 发现的核心问题

**问题1：数据加载失败时直接返回**
```javascript
// 有问题的代码
loadData() {
  const shopInfo = app.globalData.shopInfo;
  const currentKitchen = app.globalData.currentKitchen;
  
  if (!shopInfo || !currentKitchen) {
    // 直接返回，不设置任何数据
    return;
  }
  // ...
}
```

**后果**：
- 页面的 `data` 中所有字段都是初始值（null 或空数组）
- WXML 模板无法渲染内容
- 页面显示空白

**问题2：初始化时序问题**
- `app.onLaunch()` 可能还没完成
- `kitchen.onLoad()` 就开始执行
- 导致 `globalData` 数据不存在

## ✅ 修复方案

### 1. 添加数据初始化检查

```javascript
loadData() {
  // 如果数据为空，重新初始化
  if (!app.globalData.shopInfo || !app.globalData.currentKitchen) {
    console.log('globalData数据为空，尝试重新初始化');
    app.initLocalData();
  }
  
  // 获取数据，如果还是空，使用默认值
  const finalShopInfo = shopInfo || {
    id: 'shop_001',
    name: '我的小店',
    avatar: '',
    background: '',
    intro: '欢迎来到我的小店'
  };
  
  const finalCurrentKitchen = currentKitchen || {
    id: 'kitchen_001',
    name: '主厨房',
    isDefault: true,
    admins: []
  };
  
  // 确保一定会设置数据到页面
  this.setData({
    shopInfo: finalShopInfo,
    currentKitchen: finalCurrentKitchen,
    // ...
  });
}
```

### 2. 增加延迟时间

```javascript
onLoad(options) {
  // 确保 app 已经初始化
  if (!app.globalData.shopInfo) {
    app.initLocalData();
  }
  
  // 延迟从 100ms 增加到 200ms
  setTimeout(() => {
    this.loadData();
  }, 200);
}
```

### 3. 添加详细日志

在关键位置添加日志输出：
- `onLoad` 开始和结束
- `onShow` 开始和结束  
- `loadData` 开始和结束
- `filterRecipes` 的每个步骤

## 🧪 如何调试

### 步骤1：打开开发者工具

1. 打开微信开发者工具
2. 清除缓存：工具 → 清除 → 清除数据缓存
3. 重新编译

### 步骤2：查看控制台日志

应该看到以下日志顺序：

```
App onLaunch
开始初始化本地数据...
读取到的shopInfo: null (或对象)
App初始化完成
shopInfo: {id: 'shop_001', ...}
currentKitchen: {id: 'kitchen_001', ...}

===== kitchen onLoad 开始 =====
options: {}
===== kitchen onLoad 结束 =====

开始加载数据
===== loadData 开始 =====
loadData - shopInfo: {id: 'shop_001', ...}
loadData - currentKitchen: {id: 'kitchen_001', ...}
最终使用的数据:
finalShopInfo: {id: 'shop_001', ...}
finalCurrentKitchen: {id: 'kitchen_001', ...}
categories数量: 10
recipes数量: 0
kitchenRecipes数量: 0
setData完成，开始过滤菜谱
filterRecipes 开始
recipes: []
开始筛选，总数: 0
最终筛选结果: 0
filterRecipes 完成
===== loadData 结束 =====

===== kitchen onShow 开始 =====
onShow - userInfo: null (未登录)
===== loadData 开始 =====
...
===== kitchen onShow 结束 =====
```

### 步骤3：检查数据

在控制台输入以下命令检查：

```javascript
// 检查 app 数据
getApp().globalData

// 检查页面数据
getCurrentPages()[getCurrentPages().length - 1].data

// 检查 Storage
wx.getStorageInfoSync()
```

### 步骤4：分析问题

根据日志判断：

#### 情况A：看不到任何日志
**问题**：页面根本没有加载
**解决**：
- 检查 app.json 中页面路径是否正确
- 检查是否有 JS 语法错误

#### 情况B：看到日志但 shopInfo 为 null
**问题**：数据初始化失败
**解决**：
- 查看 `app.js` 的 `initLocalData()` 是否正常执行
- 检查是否有权限问题（Storage 读写失败）

#### 情况C：数据都正常但页面空白
**问题**：WXML 渲染问题
**解决**：
- 检查 `filteredRecipes` 是否为空数组
- 检查是否因为没有菜谱数据导致显示空状态

#### 情况D：recipes数量为0
**问题**：没有菜谱数据（正常情况）
**预期**：页面应该显示"暂无菜谱"的空状态

## 📊 正常的空白页面 vs 异常的空白页面

### 正常情况（没有菜谱）

**日志**：
```
recipes数量: 0
filteredRecipes: []
```

**页面显示**：
- ✅ 显示店铺头像和名称
- ✅ 显示分类列表
- ✅ 显示"暂无菜谱"空状态
- ✅ 显示"添加菜谱"提示

### 异常情况（数据加载失败）

**日志**：
```
数据加载失败 - shopInfo或currentKitchen为空
```

**页面显示**：
- ❌ 完全空白
- ❌ 没有任何内容

## 🔧 紧急修复

如果页面仍然空白，执行以下操作：

### 方法1：手动清除所有数据

```javascript
// 在控制台执行
wx.clearStorageSync();
```

然后重新编译小程序。

### 方法2：强制重新初始化

在 `app.js` 的 `onLaunch` 中添加：

```javascript
onLaunch() {
  // 强制清除旧数据
  wx.removeStorageSync('shopInfo');
  
  // 重新初始化
  this.initLocalData();
}
```

### 方法3：检查代码是否保存

确保所有修改的文件都已保存：
- `app.js`
- `pages/kitchen/kitchen.js`

然后重新编译。

## 📝 检查清单

调试前请确认：

- [ ] 微信开发者工具已打开
- [ ] 已清除数据缓存
- [ ] 已重新编译
- [ ] 控制台 Console 标签已打开
- [ ] 没有 JS 错误（红色）
- [ ] `app.js` 修改已保存
- [ ] `kitchen.js` 修改已保存

## 💡 理解数据流

```
App启动
  ↓
app.onLaunch()
  ↓
app.initLocalData()
  ↓ 创建/读取
shopInfo → Storage
  ↓
app.globalData.shopInfo = shopInfo
  ↓
kitchen.onLoad()
  ↓ 延迟200ms
kitchen.loadData()
  ↓ 获取
app.globalData.shopInfo
  ↓ 设置到页面
kitchen.setData({shopInfo})
  ↓
WXML渲染
  ↓
页面显示
```

## 🎯 预期结果

修复后，即使没有菜谱，页面也应该显示：

1. **顶部区域**：
   - 店铺头像
   - 店铺名称："我的小店"
   - 厨房名称："主厨房 · 共0个菜谱"
   - 未登录提示（如果未登录）

2. **导航栏**：
   - "点单" 标签
   - "🔍 搜索" 按钮

3. **左侧分类栏**：
   - "全部"
   - 10个默认分类

4. **主内容区**：
   - 空状态图标 🍽️
   - "暂无菜谱"
   - "点击右上角'添加菜谱'开始添加吧"
   - （如果是管理员）"立即添加" 按钮

5. **底部操作栏**：
   - 购物车图标
   - "邀请下单" 按钮
   - "下单" 按钮

## 🚨 如果还是不行

请提供以下信息：

1. **完整的控制台日志**（从启动到空白页面）
2. **globalData 的值**（执行 `getApp().globalData`）
3. **页面 data 的值**（执行 `getCurrentPages()[getCurrentPages().length - 1].data`）
4. **Storage 信息**（执行 `wx.getStorageInfoSync()`）
5. **是否有报错**（红色的错误信息）

有了这些信息，可以进一步精确定位问题。
