# èœè°±æ•°æ®ä¸¢å¤±é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š
- æ·»åŠ å®Œèœè°±åï¼Œæœ¬æ¥æœ‰5é“èœ
- ç‚¹å‡»"å…¨éƒ¨"åˆ†ç±»åï¼Œåªå‰©1é“èœ
- å†ç‚¹å‡»å…¶ä»–åˆ†ç±»ï¼Œä¸€é“éƒ½æ²¡æœ‰äº†

## ğŸ” é—®é¢˜åˆ†æ

ä»æ§åˆ¶å°æ—¥å¿—å¯ä»¥çœ‹å‡ºï¼š

```
# ç¬¬ä¸€æ¬¡ filterRecipes
recipes: (5) [{â€¦}, {â€¦}, {â€¦}, {â€¦}, {â€¦}]  â† 5é“èœ
æœ€ç»ˆç­›é€‰ç»“æœ: 5

# ç¬¬äºŒæ¬¡ filterRecipes (ç‚¹å‡»"å…¨éƒ¨"å)
recipes: [{â€¦}]  â† åªå‰©1é“èœï¼
æœ€ç»ˆç­›é€‰ç»“æœ: 1

# ç¬¬ä¸‰æ¬¡ filterRecipes (ç‚¹å‡»"ç¡¬æ ¸è¤èœ"å)
recipes: [{â€¦}]  â† è¿˜æ˜¯1é“èœ
æŒ‰åˆ†ç±»ç­›é€‰å: 0  â† è¿™é“èœä¸å±äºè¿™ä¸ªåˆ†ç±»
```

**é—®é¢˜æ ¹å› **ï¼š`this.data.recipes` æ•°ç»„è¢«æ„å¤–ä¿®æ”¹æˆ–è¦†ç›–

### å¯èƒ½çš„åŸå› 

1. **onShow ä¸­è°ƒç”¨ loadData å¯¼è‡´å¹¶å‘é—®é¢˜**
   ```javascript
   onShow() {
     this.loadData();  // æ¯æ¬¡é¡µé¢æ˜¾ç¤ºéƒ½é‡æ–°åŠ è½½
   }
   ```

2. **setData å¼‚æ­¥ç‰¹æ€§å¯¼è‡´çš„æ—¶åºé—®é¢˜**
   ```javascript
   this.setData({
     recipes: kitchenRecipes
   }, () => {
     this.filterRecipes();  // å›è°ƒä¸­æ‰§è¡Œ
   });
   ```
   
   å¦‚æœç”¨æˆ·åœ¨ setData æ‰§è¡ŒæœŸé—´ç‚¹å‡»åˆ†ç±»ï¼Œå¯èƒ½å¯¼è‡´ `this.data.recipes` å¤„äºä¸ç¡®å®šçŠ¶æ€

3. **å¤šæ¬¡è°ƒç”¨å¯¼è‡´æ•°æ®è¦†ç›–**
   - onLoad â†’ loadData
   - onShow â†’ loadDataï¼ˆæ·»åŠ èœè°±åè¿”å›ï¼‰
   - ç”¨æˆ·ç‚¹å‡» â†’ selectCategory â†’ filterRecipes
   - ä¸‰è€…å¯èƒ½å¹¶å‘æ‰§è¡Œï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

**ä¸è¦åœ¨ onShow ä¸­æ— è„‘è°ƒç”¨ loadData**ï¼Œè€Œæ˜¯ï¼š
1. åªé‡æ–°è¯»å– Storage ä¸­çš„æœ€æ–°æ•°æ®
2. å¯¹æ¯”æ•°æ®æ˜¯å¦çœŸçš„å˜åŒ–
3. åªåœ¨å¿…è¦æ—¶æ›´æ–° recipes

### ä¿®å¤ä»£ç 

**ä¿®å¤å‰**ï¼š
```javascript
onShow() {
  this.setData({
    userInfo: userInfo,
    isAdmin: app.checkIsAdmin()
  });
  
  // âŒ æ¯æ¬¡éƒ½é‡æ–°åŠ è½½ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®è¦†ç›–
  this.loadData();
  this.updateCartCount();
}
```

**ä¿®å¤å**ï¼š
```javascript
onShow() {
  this.setData({
    userInfo: userInfo,
    isAdmin: app.checkIsAdmin()
  });
  
  // â­ åªé‡æ–°åŠ è½½ Storage ä¸­çš„æ•°æ®ï¼Œä¸ç›²ç›®æ›´æ–°
  const recipes = wx.getStorageSync('recipes') || [];
  const categories = wx.getStorageSync('categories') || [];
  const currentKitchen = app.globalData.currentKitchen;
  
  if (currentKitchen) {
    const kitchenRecipes = recipes.filter(r => 
      !r.kitchenId || r.kitchenId === currentKitchen.id
    ).map(r => {
      const category = categories.find(c => c.id === r.categoryId);
      return Object.assign({}, r, {
        categoryName: category ? category.name : ''
      });
    });
    
    // â­ åªåœ¨æ•°æ®çœŸçš„å˜åŒ–æ—¶æ‰æ›´æ–°
    if (kitchenRecipes.length !== this.data.recipes.length) {
      console.log('æ£€æµ‹åˆ°èœè°±æ•°é‡å˜åŒ–ï¼Œæ›´æ–°æ•°æ®');
      this.setData({
        recipes: kitchenRecipes
      }, () => {
        this.filterRecipes();
      });
    } else {
      // æ•°æ®æ²¡å˜ï¼Œåªæ›´æ–°ç­›é€‰ç»“æœ
      this.filterRecipes();
    }
  }
  
  this.updateCartCount();
}
```

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ âŒ

```
ç”¨æˆ·æ·»åŠ èœè°±
  â†“
è¿”å›å¨æˆ¿é¡µé¢
  â†“
onShow è¢«è°ƒç”¨
  â†“
loadData() è¢«è°ƒç”¨
  â†“
setData({ recipes: [...] })  â† å¼‚æ­¥ï¼
  â†“
ç”¨æˆ·ç‚¹å‡»"å…¨éƒ¨"åˆ†ç±»
  â†“
selectCategory() è¢«è°ƒç”¨
  â†“
filterRecipes() è¢«è°ƒç”¨
  â†“
this.data.recipes å¯èƒ½å¤„äºä¸ç¡®å®šçŠ¶æ€
  â†“
âŒ æ•°æ®ä¸¢å¤±æˆ–é”™ä¹±
```

### ä¿®å¤å âœ…

```
ç”¨æˆ·æ·»åŠ èœè°±
  â†“
è¿”å›å¨æˆ¿é¡µé¢
  â†“
onShow è¢«è°ƒç”¨
  â†“
è¯»å– Storage æ•°æ®
  â†“
å¯¹æ¯”æ•°æ®æ˜¯å¦å˜åŒ–
  â†“
  å¦‚æœå˜åŒ–ï¼š
    æ›´æ–° recipes + filterRecipes
  â†“
  å¦‚æœæœªå˜åŒ–ï¼š
    åªè°ƒç”¨ filterRecipes
  â†“
ç”¨æˆ·ç‚¹å‡»åˆ†ç±»
  â†“
selectCategory() â†’ filterRecipes()
  â†“
âœ… æ•°æ®ç¨³å®šï¼Œä¸ä¼šä¸¢å¤±
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ç¼–è¯‘
```
1. å¾®ä¿¡å¼€å‘è€…å·¥å…· â†’ å·¥å…· â†’ æ¸…é™¤ â†’ å…¨éƒ¨æ¸…é™¤
2. ç‚¹å‡»"ç¼–è¯‘"æŒ‰é’®
```

### æ­¥éª¤ 2ï¼šæµ‹è¯•åœºæ™¯

#### æµ‹è¯• Aï¼šæ·»åŠ èœè°±åè¿”å›
1. ç¡®ä¿å½“å‰æœ‰å‡ é“èœè°±ï¼ˆè®°å½•æ•°é‡ï¼‰
2. ç‚¹å‡»"æ·»åŠ èœè°±"
3. å¡«å†™ä¿¡æ¯å¹¶ä¿å­˜
4. è¿”å›å¨æˆ¿é¡µé¢
5. **âœ… åº”è¯¥çœ‹åˆ°æ‰€æœ‰èœè°±ï¼ˆåŒ…æ‹¬æ–°æ·»åŠ çš„ï¼‰**
6. ç‚¹å‡»"å…¨éƒ¨"åˆ†ç±»
7. **âœ… åº”è¯¥è¿˜æ˜¯æ˜¾ç¤ºæ‰€æœ‰èœè°±ï¼Œæ•°é‡ä¸å˜**

#### æµ‹è¯• Bï¼šå¿«é€Ÿåˆ‡æ¢åˆ†ç±»
1. åœ¨å¨æˆ¿é¡µé¢ï¼Œæœ‰å¤šé“èœè°±
2. å¿«é€Ÿç‚¹å‡»ä¸åŒçš„åˆ†ç±»ï¼šå…¨éƒ¨ â†’ ç”°å›­æ—¶è”¬ â†’ å…¨éƒ¨ â†’ ç¡¬æ ¸è¤èœ
3. **âœ… æ¯æ¬¡åˆ‡æ¢éƒ½åº”è¯¥æ­£ç¡®ç­›é€‰ï¼Œä¸ä¸¢å¤±æ•°æ®**
4. å›åˆ°"å…¨éƒ¨"
5. **âœ… åº”è¯¥æ˜¾ç¤ºæ‰€æœ‰èœè°±**

#### æµ‹è¯• Cï¼šç¼–è¾‘èœè°±åè¿”å›
1. ç‚¹å‡»ç¼–è¾‘æŸä¸ªèœè°±
2. ä¿®æ”¹ä¿¡æ¯å¹¶ä¿å­˜
3. è¿”å›å¨æˆ¿é¡µé¢
4. **âœ… æ‰€æœ‰èœè°±éƒ½åº”è¯¥æ­£å¸¸æ˜¾ç¤º**
5. ç‚¹å‡»å„ä¸ªåˆ†ç±»
6. **âœ… ç­›é€‰åŠŸèƒ½æ­£å¸¸ï¼Œæ•°æ®ä¸ä¸¢å¤±**

## ğŸ“ é¢„æœŸç»“æœ

**âœ… æˆåŠŸçš„æ ‡å¿—ï¼š**

1. **æ·»åŠ èœè°±å**ï¼š
   - è¿”å›é¡µé¢æ˜¾ç¤ºæ‰€æœ‰èœè°±ï¼ˆåŒ…æ‹¬æ–°æ·»åŠ çš„ï¼‰
   - ç‚¹å‡»åˆ†ç±»æ­£å¸¸ç­›é€‰
   - æ•°æ®ä¸ä¸¢å¤±

2. **åˆ‡æ¢åˆ†ç±»æ—¶**ï¼š
   - ç­›é€‰ç»“æœæ­£ç¡®
   - recipes æ•°ç»„ä¿æŒå®Œæ•´
   - æ§åˆ¶å°æ—¥å¿—æ˜¾ç¤ºæ­£ç¡®çš„æ•°é‡

3. **æ§åˆ¶å°æ—¥å¿—**ï¼š
   ```
   # onShow
   æ£€æµ‹åˆ°èœè°±æ•°é‡å˜åŒ–ï¼Œæ›´æ–°æ•°æ®  â† åªåœ¨çœŸçš„å˜åŒ–æ—¶å‡ºç°
   
   # filterRecipes
   recipes: (5) [{â€¦}, {â€¦}, {â€¦}, {â€¦}, {â€¦}]  â† å§‹ç»ˆä¿æŒ5ä¸ª
   å¼€å§‹ç­›é€‰ï¼Œæ€»æ•°: 5
   æŒ‰åˆ†ç±»ç­›é€‰å: 2  â† æ ¹æ®åˆ†ç±»æ­£ç¡®ç­›é€‰
   æœ€ç»ˆç­›é€‰ç»“æœ: 2
   ```

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹

### 1. é¿å…ä¸å¿…è¦çš„ loadData

**é—®é¢˜**ï¼š
```javascript
onShow() {
  this.loadData();  // æ¯æ¬¡éƒ½é‡æ–°åŠ è½½æ•´ä¸ªæ•°æ®
}
```

**è§£å†³**ï¼š
```javascript
onShow() {
  // åªè¯»å–æ–°æ•°æ®ï¼Œæ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
  const newRecipes = wx.getStorageSync('recipes');
  if (newRecipes.length !== this.data.recipes.length) {
    // åªåœ¨æ•°é‡å˜åŒ–æ—¶æ›´æ–°
    this.setData({ recipes: newRecipes });
  }
}
```

### 2. æ•°æ®å¯¹æ¯”ç­–ç•¥

```javascript
// ç®€å•å¯¹æ¯”ï¼šæ•°é‡
if (newRecipes.length !== this.data.recipes.length) {
  // éœ€è¦æ›´æ–°
}

// æ·±åº¦å¯¹æ¯”ï¼šå†…å®¹ï¼ˆå¦‚éœ€è¦ï¼‰
const changed = newRecipes.some((r, i) => 
  r.id !== this.data.recipes[i]?.id
);
```

### 3. setData å›è°ƒæ—¶åº

```javascript
this.setData({
  recipes: newData
}, () => {
  // ç¡®ä¿ this.data.recipes å·²æ›´æ–°
  this.filterRecipes();
});

// é¿å…ï¼š
this.setData({ recipes: newData });
this.filterRecipes();  // âŒ this.data.recipes å¯èƒ½è¿˜æ˜¯æ—§æ•°æ®
```

### 4. é˜²æŠ–ä¿æŠ¤

å¦‚æœæ‹…å¿ƒç”¨æˆ·å¿«é€Ÿç‚¹å‡»ï¼Œå¯ä»¥æ·»åŠ é˜²æŠ–ï¼š

```javascript
selectCategory(e) {
  const categoryId = e.currentTarget.dataset.id;
  
  // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
  if (this.filterTimer) {
    clearTimeout(this.filterTimer);
  }
  
  this.setData({ selectedCategory: categoryId });
  
  // å»¶è¿Ÿæ‰§è¡Œç­›é€‰
  this.filterTimer = setTimeout(() => {
    this.filterRecipes();
  }, 100);
}
```

## ğŸ¯ æœ€ä½³å®è·µæ€»ç»“

### 1. é¡µé¢ç”Ÿå‘½å‘¨æœŸç®¡ç†

```javascript
// onLoadï¼šé¦–æ¬¡åŠ è½½ï¼Œå®Œæ•´åˆå§‹åŒ–
onLoad() {
  this.loadData();
}

// onShowï¼šé¡µé¢æ˜¾ç¤ºï¼Œæ™ºèƒ½æ›´æ–°
onShow() {
  // åªåœ¨å¿…è¦æ—¶æ›´æ–°æ•°æ®
  this.smartUpdate();
}
```

### 2. æ•°æ®æ›´æ–°ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯»å– Storage æ•°æ®              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¯¹æ¯”å½“å‰ data                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ˜¯å¦å˜åŒ–ï¼Ÿ                     â”‚
â”‚    â”œâ”€ æ˜¯ â†’ setData + filter    â”‚
â”‚    â””â”€ å¦ â†’ åª filter           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. é¿å…å¹¶å‘é—®é¢˜

- å‡å°‘ä¸å¿…è¦çš„æ•°æ®é‡æ–°åŠ è½½
- ä½¿ç”¨æ•°æ®å¯¹æ¯”é¿å…æ— æ•ˆæ›´æ–°
- ç¡®ä¿ setData å›è°ƒä¸­æ‰§è¡Œä¾èµ–æ“ä½œ
- è€ƒè™‘æ·»åŠ é˜²æŠ–ä¿æŠ¤

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ€§èƒ½ä¼˜åŒ–

åªæ›´æ–°å˜åŒ–çš„æ•°æ®ï¼Œè€Œä¸æ˜¯æ•´ä¸ª recipes æ•°ç»„ï¼š

```javascript
// å½“å‰ï¼šæ›´æ–°æ•´ä¸ªæ•°ç»„
this.setData({ recipes: newRecipes });

// ä¼˜åŒ–ï¼šåªæ›´æ–°å˜åŒ–çš„é¡¹
this.setData({
  [`recipes[${index}]`]: updatedRecipe
});
```

### 2. çŠ¶æ€ç®¡ç†

è€ƒè™‘å¼•å…¥æ›´å®Œå–„çš„çŠ¶æ€ç®¡ç†ï¼š

```javascript
// é›†ä¸­ç®¡ç†çŠ¶æ€
const dataManager = {
  recipes: [],
  filters: { category: 'all', keyword: '' },
  
  updateRecipes(newRecipes) {
    this.recipes = newRecipes;
    this.notifyChange();
  },
  
  getFiltered() {
    return this.recipes.filter(/* ... */);
  }
};
```

### 3. æ•°æ®ç¼“å­˜

é¿å…é¢‘ç¹è¯»å– Storageï¼š

```javascript
// åœ¨ App çº§åˆ«ç¼“å­˜æ•°æ®
App({
  globalData: {
    recipesCache: null,
    cacheTime: 0
  },
  
  getRecipes() {
    const now = Date.now();
    if (this.globalData.recipesCache && 
        now - this.globalData.cacheTime < 5000) {
      return this.globalData.recipesCache;
    }
    
    const recipes = wx.getStorageSync('recipes');
    this.globalData.recipesCache = recipes;
    this.globalData.cacheTime = now;
    return recipes;
  }
});
```

## âœ¨ æ€»ç»“

**é—®é¢˜åŸå› **ï¼š
- onShow ä¸­æ— æ¡ä»¶è°ƒç”¨ loadData
- setData å¼‚æ­¥ç‰¹æ€§å¯¼è‡´æ—¶åºé—®é¢˜
- å¹¶å‘æ“ä½œå¯¼è‡´æ•°æ®è¦†ç›–

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°æ•°æ®
- åªåœ¨å¿…è¦æ—¶è°ƒç”¨ setData
- ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

**ä¿®å¤æ•ˆæœ**ï¼š
- âœ… æ•°æ®ä¸å†ä¸¢å¤±
- âœ… åˆ†ç±»ç­›é€‰æ­£å¸¸
- âœ… ç”¨æˆ·ä½“éªŒæµç•…

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2026-01-18  
**ä¿®å¤æ–¹æ³•**ï¼šæ™ºèƒ½æ•°æ®æ›´æ–°ç­–ç•¥  
**æµ‹è¯•çŠ¶æ€**ï¼šå¾…éªŒè¯
