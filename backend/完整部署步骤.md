# 完整部署步骤（已配置好）

## 服务器信息

- **IP地址**: 47.112.167.11
- **系统**: AlibabaCloudLinux
- **配置**: 2核2GB，40GB系统盘

## 已配置的信息

- ✅ 小程序AppID: wxc3444090274b6825
- ✅ 小程序Secret: 709e1351be01dac7f40c9102352b3655
- ✅ 服务器地址: http://47.112.167.11:3000/api

## 部署步骤

### 方式A：一键部署（推荐）

#### 步骤1：在本地电脑上传文件

```bash
cd /Users/liuwenlin/Documents/Self/CookingApp2/backend
./上传文件.sh
```

或者手动上传：

```bash
scp simple-server.js package.json 一键部署.sh root@47.112.167.11:/opt/cooking-app-backend
```

#### 步骤2：连接到服务器

```bash
ssh root@47.112.167.11
```

#### 步骤3：运行一键部署脚本

```bash
cd /opt/cooking-app-backend
chmod +x 一键部署.sh
./一键部署.sh
```

脚本会自动完成：
- ✅ 安装 Node.js
- ✅ 安装依赖
- ✅ 创建配置文件（已填入你的小程序信息）
- ✅ 启动服务
- ✅ 配置防火墙
- ✅ 测试服务

### 方式B：手动部署

如果一键部署失败，可以手动执行：

#### 步骤1：连接到服务器

```bash
ssh root@47.112.167.11
```

#### 步骤2：安装 Node.js

```bash
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs
node -v  # 检查版本
```

#### 步骤3：安装 PM2

```bash
sudo npm install -g pm2
```

#### 步骤4：创建项目目录并上传文件

```bash
mkdir -p /opt/cooking-app-backend
cd /opt/cooking-app-backend
# 上传 simple-server.js 和 package.json 到这里
```

#### 步骤5：安装依赖

```bash
npm install express axios cors
```

#### 步骤6：创建配置文件

```bash
cat > .env << 'EOF'
PORT=3000
NODE_ENV=production
DATA_DIR=/opt/cooking-app-backend/data
WX_APP_ID=wxc3444090274b6825
WX_APP_SECRET=709e1351be01dac7f40c9102352b3655
EOF
```

#### 步骤7：创建数据目录

```bash
mkdir -p data
chmod 755 data
```

#### 步骤8：启动服务

```bash
pm2 start simple-server.js --name cooking-app-backend
pm2 save
pm2 startup
```

#### 步骤9：配置防火墙

```bash
sudo firewall-cmd --permanent --add-port=3000/tcp
sudo firewall-cmd --reload
```

#### 步骤10：测试服务

```bash
curl http://localhost:3000/health
```

应该返回：
```json
{"success":true,"message":"服务运行正常","timestamp":"...","storage":"本地存储"}
```

## 配置小程序

小程序配置已自动更新：

**`utils/cloudStorage.js`** 已配置为：
```javascript
apiBaseUrl: 'http://47.112.167.11:3000/api'
```

## 测试

### 1. 测试后端服务

在服务器上：
```bash
curl http://localhost:3000/health
```

在本地电脑：
```bash
curl http://47.112.167.11:3000/health
```

### 2. 测试小程序登录

1. 在小程序中点击登录
2. 查看控制台日志，应该看到：
   ```
   ✅ 获取 openid 成功
   用户 openid: oXXXXXXXXXXXXX（真实的openid）
   ```

### 3. 测试数据同步

1. 在小程序中创建一些数据（菜谱、厨房等）
2. 数据会自动上传到服务器
3. 在另一台设备登录，数据会自动同步

## 数据存储位置

数据存储在服务器本地：
```
/opt/cooking-app-backend/data/users/{openid}/
  ├── shopInfo.json
  ├── recipes.json
  ├── orders.json
  └── categories.json
```

## 常用命令

```bash
# 查看服务状态
pm2 status

# 查看日志
pm2 logs cooking-app-backend

# 查看最近50行日志
pm2 logs cooking-app-backend --lines 50

# 重启服务
pm2 restart cooking-app-backend

# 停止服务
pm2 stop cooking-app-backend

# 查看数据目录大小
du -sh /opt/cooking-app-backend/data

# 查看数据文件
ls -lh /opt/cooking-app-backend/data/users/
```

## 备份数据

```bash
# 备份数据目录
tar -czf backup-$(date +%Y%m%d).tar.gz /opt/cooking-app-backend/data

# 下载到本地
scp root@47.112.167.11:/opt/cooking-app-backend/backup-*.tar.gz ./
```

## 故障排查

### 1. 服务无法启动

```bash
# 查看详细错误
pm2 logs cooking-app-backend --lines 50

# 检查端口是否被占用
netstat -tulpn | grep 3000
```

### 2. 无法访问服务

```bash
# 检查防火墙
sudo firewall-cmd --list-ports

# 检查服务状态
pm2 status

# 检查服务是否监听
netstat -tulpn | grep 3000
```

### 3. 获取 openid 失败

- 检查 `.env` 文件中的小程序信息是否正确
- 查看服务器日志：`pm2 logs cooking-app-backend`
- 检查网络连接

## 下一步

1. ✅ 运行一键部署脚本
2. ✅ 测试服务是否正常
3. ✅ 在小程序中测试登录
4. ✅ 测试数据同步功能

部署完成后，你的小程序就可以正常使用云存储功能了！
