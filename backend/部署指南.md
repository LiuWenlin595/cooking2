# 阿里云服务器部署指南

## 服务器信息

- **公网IP**: 47.112.167.11
- **系统**: AlibabaCloudLinux
- **配置**: 2 vCPU, 2 GiB内存, 40 GiB ESSD云盘

## 部署步骤

### 步骤1：连接到服务器

使用 SSH 连接到服务器：

```bash
ssh root@47.112.167.11
# 或使用你的用户名
ssh your-username@47.112.167.11
```

### 步骤2：上传项目文件

**方式A：使用 scp 命令**

在你的本地电脑执行：

```bash
cd /Users/liuwenlin/Documents/Self/CookingApp2/backend
scp -r * root@47.112.167.11:/opt/cooking-app-backend
```

**方式B：使用 Git（推荐）**

如果项目在 Git 仓库中：

```bash
# 在服务器上
cd /opt
git clone your-repo-url cooking-app-backend
cd cooking-app-backend/backend
```

**方式C：使用 FTP 工具**

使用 FileZilla 等 FTP 工具上传文件。

### 步骤3：运行部署脚本

```bash
cd /opt/cooking-app-backend
chmod +x deploy.sh
./deploy.sh
```

### 步骤4：配置环境变量

编辑配置文件：

```bash
nano /opt/cooking-app-backend/.env
```

填入以下信息（需要你提供）：

```env
# 服务器配置
PORT=3000
NODE_ENV=production

# 阿里云OSS配置
OSS_REGION=oss-cn-hangzhou  # 你的OSS区域
OSS_ACCESS_KEY_ID=你的AccessKeyId
OSS_ACCESS_KEY_SECRET=你的AccessKeySecret
OSS_BUCKET=你的Bucket名称

# 微信小程序配置
WX_APP_ID=你的小程序AppID
WX_APP_SECRET=你的小程序AppSecret
```

**需要你提供的信息：**

1. **阿里云OSS信息**：
   - OSS区域（如：oss-cn-hangzhou）
   - AccessKeyId
   - AccessKeySecret
   - Bucket名称

2. **微信小程序信息**：
   - 小程序AppID
   - 小程序AppSecret

### 步骤5：配置防火墙

开放 3000 端口（后端服务端口）：

```bash
# 使用 firewalld
sudo firewall-cmd --permanent --add-port=3000/tcp
sudo firewall-cmd --reload

# 或使用 iptables
sudo iptables -A INPUT -p tcp --dport 3000 -j ACCEPT
sudo service iptables save
```

### 步骤6：启动服务

```bash
cd /opt/cooking-app-backend
pm2 start aliyun-oss-server.js --name cooking-app-backend
pm2 save
pm2 startup
```

### 步骤7：测试服务

```bash
# 测试健康检查
curl http://47.112.167.11:3000/health

# 应该返回：
# {"success":true,"message":"服务运行正常","timestamp":"..."}
```

### 步骤8：配置Nginx反向代理（可选但推荐）

**安装 Nginx：**

```bash
sudo yum install -y nginx
```

**配置 Nginx：**

```bash
sudo cp /opt/cooking-app-backend/nginx.conf /etc/nginx/conf.d/cooking-app-backend.conf
sudo nginx -t  # 测试配置
sudo systemctl start nginx
sudo systemctl enable nginx
```

**开放 80 端口：**

```bash
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --reload
```

现在可以通过 `http://47.112.167.11` 访问服务。

## 配置小程序

编辑 `utils/cloudStorage.js`：

```javascript
const config = {
  apiBaseUrl: 'http://47.112.167.11:3000/api',  // 使用IP地址
  // 或如果配置了域名：
  // apiBaseUrl: 'https://your-domain.com/api'
};
```

## 常用命令

```bash
# 查看服务状态
pm2 status

# 查看日志
pm2 logs cooking-app-backend

# 重启服务
pm2 restart cooking-app-backend

# 停止服务
pm2 stop cooking-app-backend

# 查看服务信息
pm2 info cooking-app-backend
```

## 配置SSL证书（可选，推荐）

如果需要使用 HTTPS：

1. **申请SSL证书**（可以使用 Let's Encrypt 免费证书）
2. **配置 Nginx**（参考 nginx.conf 中的 HTTPS 配置）
3. **修改小程序配置**为 HTTPS 地址

## 需要你提供的信息

请提供以下信息，我会帮你完善配置：

1. **阿里云OSS配置**：
   - [ ] OSS区域（如：oss-cn-hangzhou, oss-cn-beijing 等）
   - [ ] AccessKeyId
   - [ ] AccessKeySecret
   - [ ] Bucket名称

2. **微信小程序配置**：
   - [ ] 小程序AppID
   - [ ] 小程序AppSecret

3. **其他信息**（可选）：
   - [ ] 是否配置域名（如果有域名）
   - [ ] 是否需要配置SSL证书

## 故障排查

### 1. 服务无法启动

```bash
# 查看详细错误
pm2 logs cooking-app-backend --lines 50

# 检查端口是否被占用
netstat -tulpn | grep 3000
```

### 2. 无法访问服务

```bash
# 检查防火墙
sudo firewall-cmd --list-ports

# 检查服务状态
pm2 status
```

### 3. 获取 openid 失败

- 检查微信小程序 AppID 和 AppSecret 是否正确
- 检查网络连接
- 查看服务器日志：`pm2 logs cooking-app-backend`
