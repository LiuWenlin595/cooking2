# 完整权限系统使用说明

## 🎯 系统概述

本小程序采用基于**用户唯一ID（userId）**的权限管理系统，确保管理员身份的安全性和可靠性。

## 🔐 核心机制

### 用户标识体系

```
用户身份 = userId（唯一且不可变）
管理员验证 = userId 匹配
```

**优势**：
- ✅ 不依赖可修改的昵称
- ✅ 唯一标识，无法伪造
- ✅ 持久有效，不会过期

## 📱 功能矩阵

### 普通用户功能
| 功能 | 权限 | 说明 |
|------|------|------|
| 浏览菜谱 | ✅ | 查看所有菜谱 |
| 搜索菜谱 | ✅ | 按名称、分类搜索 |
| 添加到购物车 | ✅ | 选择菜品 |
| 查看购物车 | ✅ | 管理购物车 |
| 下单 | ✅ | 创建订单 |
| 查看订单 | ✅ | 查看历史订单 |
| 我的二维码 | ✅ | 生成专属二维码 |
| 更换账号 | ✅ | 切换用户 |
| 退出登录 | ✅ | 注销账号 |

### 管理员独享功能
| 功能 | 权限 | 说明 |
|------|------|------|
| 添加菜谱 | 👑 | 仅管理员 |
| 编辑菜谱 | 👑 | 仅管理员 |
| 删除菜谱 | 👑 | 仅管理员 |
| 管理分类 | 👑 | 仅管理员 |
| 接单 | 👑 | 仅管理员 |
| 出餐 | 👑 | 仅管理员 |
| 管理后台 | 👑 | 仅管理员 |
| 添加管理员 | 👑 | 仅管理员 |

## 🎬 完整使用流程

### 流程1：首次设置（管理员）

```
1. 【登录】
   - 打开小程序
   - 点击"点击登录"
   - 授权获取微信信息
   - 生成 userId
   
2. 【自动成为管理员】
   - 首位用户自动获得管理员权限
   - 看到"👑 管理后台"入口
   
3. 【设置店铺】
   - 我的 → 店铺设置
   - 上传头像、背景
   - 填写店铺信息
   
4. 【添加分类】
   - 我的 → 管理后台 → 分类管理
   - 或：我的 → 分类管理
   - 添加自定义分类
   
5. 【添加菜谱】
   - 首页 → 添加菜谱
   - 或：管理后台 → 菜谱管理 → 添加
   - 填写完整信息
   
6. 【添加其他管理员】
   - 其他用户打开"我的二维码"
   - 你进入：我的 → 店铺设置 → 管理厨房
   - 选择厨房 → 管理员 → 扫码添加
   - 扫描对方二维码
```

### 流程2：成为管理员（普通用户）

```
1. 【登录】
   - 打开小程序
   - 授权登录
   - 生成 userId
   
2. 【生成二维码】
   - 我的 → 我的二维码
   - 查看专属二维码
   
3. 【展示给管理员】
   - 将二维码页面展示给现有管理员
   - 或复制 userId 发送给管理员
   
4. 【等待添加】
   - 管理员扫码或手动添加
   - 系统自动验证 userId
   - 获得管理员权限
   
5. 【验证权限】
   - 返回"我的"页面
   - 看到"👑 管理后台"入口
   - 头像旁显示"👑 管理员"标识
   - 首页出现"编辑"模式
```

### 流程3：日常使用（所有用户）

```
【点餐】
1. 浏览菜谱
2. 点击 + 加入购物车
3. 点击"下单"查看购物车
4. 调整数量
5. 点击"去下单"
6. 输入备注（可选）
7. 确认下单

【管理】（仅管理员）
1. 进入管理后台
2. 选择要管理的内容
3. 进行增删改操作
4. 处理订单
```

### 流程4：账号管理

```
【更换账号】
1. 我的 → 更换账号
2. 确认更换
3. 授权新账号登录
4. 生成新 userId
5. 需要重新获取管理员权限

【退出登录】
1. 我的 → 退出登录
2. 确认退出
3. 清除登录状态
4. 失去管理员权限
```

## 🔒 权限验证机制

### 验证时机
- ✅ 进入管理页面时
- ✅ 执行管理操作时
- ✅ 添加/编辑内容时
- ✅ 处理订单时

### 验证方式
```javascript
// 三级验证，优先级从高到低
1. userId 匹配（主要方式）
   - 最安全可靠
   
2. openid 匹配（备用）
   - 需要后端支持
   
3. nickName 匹配（兼容）
   - 仅用于向后兼容
   - 不推荐新用户使用
```

### 特殊情况：首次使用
```
条件：
- 默认厨房
- 管理员列表为空

结果：
- 首位用户自动成为管理员
- 无需添加即可使用所有功能
```

## 🎨 界面识别

### 管理员身份标识

#### 个人中心页面
```
┌─────────────────────────┐
│ 👤 张三                 │
│    欢迎使用电子菜单      │
│    [👑 管理员]          │ ← 管理员标识
├─────────────────────────┤
│ 📱 我的二维码  >        │
│ 👑 管理后台  >          │ ← 管理员专属
│ ⚙️ 店铺设置  >          │
│ 🏷️ 分类管理  >          │ ← 管理员专属
```

#### 首页（管理员）
```
┌─────────────────────────┐
│ [点单] [编辑]           │ ← 有编辑模式
│ [➕ 添加菜谱] [🔍 搜索]  │ ← 有添加按钮
```

#### 首页（普通用户）
```
┌─────────────────────────┐
│ [点单]                  │ ← 只有点单模式
│ [🔍 搜索]               │ ← 只有搜索
```

## 💡 常见场景处理

### 场景1：多人共用一台设备

**问题**：家人共用iPad/手机

**解决方案**：
```
1. A用户使用完毕后点击"更换账号"
2. B用户登录自己的账号
3. B用户根据需要操作
4. 完成后再次更换账号或退出登录
```

### 场景2：临时添加管理员

**问题**：家人来访，临时需要做饭

**解决方案**：
```
1. 访客：我的 → 我的二维码
2. 管理员：扫码添加为管理员
3. 访客获得权限，可以管理菜谱
4. 离开前：移除管理员权限
```

### 场景3：忘记登录

**问题**：使用了一段时间才发现未登录

**解决方案**：
```
1. 点击头像区域的"点击登录"
2. 授权登录
3. 如果之前是管理员，权限自动恢复（如果userId相同）
4. 如果是新userId，需要重新添加
```

### 场景4：更换手机

**问题**：换了新设备

**解决方案**：
```
1. 新设备登录
2. 生成新 userId
3. 让现有管理员重新添加
4. 或：查看"我的二维码"，扫码添加
```

## ⚠️ 重要注意事项

### 1. userId 的特性
- ✅ 设备本地生成
- ✅ 首次登录创建
- ✅ 持久保存
- ❌ 换设备会改变
- ❌ 清除后重新生成

### 2. 权限变化时机
- **立即生效**：添加/移除管理员
- **立即失效**：退出登录
- **立即变化**：更换账号

### 3. 数据保护
- **退出登录**：数据全部保留
- **更换账号**：数据全部保留
- **清空数据**：删除所有内容

### 4. 权限继承
- ❌ 更换账号不继承权限
- ❌ 重新登录不继承权限（如果userId变化）
- ✅ 同设备重新登录可能继承（如果userId未清除）

## 🔧 技术细节

### userId 生成规则
```javascript
// 格式
'user_' + 时间戳 + '_' + 随机字符串

// 示例
user_1705555555555_abc123xyz

// 长度
约 30 个字符
```

### 权限检查代码
```javascript
checkIsAdmin() {
  // 优先 userId
  if (userInfo.userId && admin.userId) {
    return admin.userId === userInfo.userId;
  }
  
  // 备用 openid
  if (userInfo.openid && admin.openid) {
    return admin.openid === userInfo.openid;
  }
  
  // 兼容 nickName
  return admin.nickName === userInfo.nickName;
}
```

### 退出登录清除内容
```javascript
// 清除
- userInfo（用户信息）
- userId（用户ID）
- globalData.userInfo（全局状态）
- globalData.isAdmin（管理员状态）

// 保留
- recipes（菜谱）
- orders（订单）
- categories（分类）
- shopInfo（店铺信息）
- cart（购物车）
```

## 📊 权限流转图

```
未登录
  ↓ 点击登录
已登录（普通用户）
  ↓ 被添加为管理员
已登录（管理员）
  ↓ 退出登录/更换账号
未登录 / 新账号（普通用户）
```

## ✅ 安全检查清单

### 添加管理员前
- [ ] 确认对方身份
- [ ] 查看对方的 userId
- [ ] 验证二维码数据
- [ ] 确认添加意图

### 移除管理员前
- [ ] 确认对方不再需要权限
- [ ] 通知对方即将移除
- [ ] 确认操作

### 退出登录前
- [ ] 确认已完成所有操作
- [ ] 了解退出后的影响
- [ ] 确认退出

### 更换账号前
- [ ] 确认需要切换用户
- [ ] 了解权限会重置
- [ ] 备份重要信息

## 🎉 总结

完整的权限系统提供：

- ✅ **安全可靠**：基于唯一ID，无法伪造
- ✅ **灵活管理**：支持多管理员协作
- ✅ **便捷操作**：扫码添加，简单快速
- ✅ **账号管理**：登录、退出、更换
- ✅ **权限控制**：严格的功能权限验证
- ✅ **数据保护**：退出不影响数据
- ✅ **向后兼容**：支持旧版本数据

通过合理使用权限系统，可以在保证安全的同时，实现高效的多人协作！
