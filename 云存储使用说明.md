# 云存储使用说明

## 功能概述

已为小程序添加阿里云OSS云存储功能，可以将数据保存到云端，实现多设备同步。每个用户的数据通过openid区分，互不干扰。

## 已创建的文件

1. **`utils/cloudStorage.js`** - 云存储工具类
2. **`backend/aliyun-oss-server.js`** - 后端服务器示例代码
3. **`backend/package.json`** - 后端依赖配置
4. **`README-云存储配置.md`** - 详细配置指南

## 快速开始

### 1. 配置后端服务

#### 方式A：使用自己的服务器

1. 将 `backend/aliyun-oss-server.js` 部署到你的服务器
2. 安装依赖：`npm install`
3. 配置OSS信息和小程序信息
4. 启动服务：`npm start`

#### 方式B：使用阿里云函数计算

1. 在阿里云函数计算中创建函数
2. 上传 `backend/aliyun-oss-server.js` 代码
3. 配置环境变量
4. 创建HTTP触发器

### 2. 配置小程序

编辑 `utils/cloudStorage.js`，修改后端服务地址：

```javascript
const config = {
  apiBaseUrl: 'https://your-server.com/api'  // 替换为你的后端地址
};
```

### 3. 启用云存储

在 `app.js` 中启用云存储：

```javascript
this.globalData.useCloudStorage = true;  // 设置为 true
```

### 4. 配置服务器域名

在微信公众平台 → 开发 → 开发管理 → 开发设置 → 服务器域名中，添加你的后端服务器域名。

## 功能说明

### 自动同步

- **登录后自动同步**：用户登录后，自动从云端下载数据
- **保存时自动上传**：数据保存时，自动上传到云端

### 数据存储结构

```
users/
  └── {openid}/
      ├── shopInfo.json      # 店铺信息
      ├── recipes.json       # 菜谱数据
      ├── orders.json        # 订单数据
      └── categories.json     # 分类数据
```

### 数据隔离

每个用户的数据通过openid区分，不同用户的数据完全隔离。

## 使用方法

### 手动同步数据

在"我的"页面，可以添加手动同步按钮：

```javascript
const cloudStorage = require('../../utils/cloudStorage');

// 同步到云端
cloudStorage.syncAllDataToCloud().then(() => {
  wx.showToast({ title: '同步成功', icon: 'success' });
});

// 从云端同步
cloudStorage.syncAllDataFromCloud().then(() => {
  wx.showToast({ title: '同步成功', icon: 'success' });
});
```

## 注意事项

1. **首次使用**：需要先配置后端服务，否则云存储功能无法使用
2. **网络要求**：需要网络连接才能同步数据
3. **数据安全**：确保后端服务使用HTTPS，保护数据传输安全
4. **备份建议**：虽然数据已保存到云端，建议定期导出备份

## 故障排查

### 1. 同步失败

- 检查后端服务是否正常运行
- 检查网络连接
- 查看控制台错误信息

### 2. 数据不一致

- 清除本地数据，重新从云端同步
- 检查openid是否正确

### 3. 上传失败

- 检查OSS配置是否正确
- 检查后端服务日志

## 下一步

1. 部署后端服务
2. 配置小程序中的后端地址
3. 启用云存储功能
4. 测试数据同步

详细配置步骤请参考 `README-云存储配置.md`。
