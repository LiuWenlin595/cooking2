# 微信小程序登录流程说明

## 新的登录方式

根据[微信官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)，已修改登录逻辑，使用标准的微信登录流程。

## 登录流程

### 1. 调用 wx.login() 获取 code

```javascript
wx.login({
  success: (res) => {
    if (res.code) {
      // res.code 是临时登录凭证，有效期5分钟
      // 将 code 发送到后端
    }
  }
})
```

**特点：**
- ✅ 不需要用户授权
- ✅ 可以直接调用
- ✅ 返回临时登录凭证 code（有效期5分钟）

### 2. 后端换取 openid

后端收到 code 后，需要调用微信服务器的 `code2Session` 接口：

```
GET https://api.weixin.qq.com/sns/jscode2session?appid=APPID&secret=SECRET&js_code=CODE&grant_type=authorization_code
```

**返回数据：**
```json
{
  "openid": "用户唯一标识",
  "session_key": "会话密钥"
}
```

### 3. 保存用户信息

小程序收到 openid 后，保存到本地：
```javascript
{
  openid: "用户唯一标识",
  session_key: "会话密钥",
  code: "临时登录凭证",
  loginTime: "登录时间"
}
```

## 与之前的区别

### 之前的方式（有问题）
- 使用 `wx.getUserProfile()` 获取用户信息
- 返回"微信用户"（默认值）
- 无法获取真实的用户身份

### 现在的方式（正确）
- 使用 `wx.login()` 获取 code
- 通过后端换取 openid
- 每个微信账号对应唯一的 openid
- 可以正确识别用户身份

## 后端接口要求

后端需要提供以下接口：

### GET /api/user/getOpenId

**请求参数：**
```json
{
  "code": "临时登录凭证"
}
```

**返回数据：**
```json
{
  "success": true,
  "data": {
    "openid": "用户唯一标识",
    "session_key": "会话密钥"
  }
}
```

## 配置后端服务

1. **编辑 `utils/cloudStorage.js`**：
   ```javascript
   const config = {
     apiBaseUrl: 'https://your-server.com/api'  // 替换为你的后端地址
   };
   ```

2. **部署后端服务**：
   - 参考 `backend/aliyun-oss-server.js`
   - 实现 `/api/user/getOpenId` 接口
   - 调用微信 `code2Session` 接口

3. **配置服务器域名**：
   - 在微信公众平台配置服务器域名
   - 添加后端服务器地址到"request合法域名"

## 测试

1. **未配置后端时**：
   - 会使用模拟的 openid（仅用于测试）
   - 控制台会显示警告信息

2. **配置后端后**：
   - 会调用后端接口获取真实的 openid
   - 每个用户都有唯一的 openid
   - 数据可以正确绑定到用户账号

## 注意事项

1. **code 只能使用一次**：
   - code 有效期5分钟
   - 每个 code 只能使用一次
   - 如果失败，需要重新调用 `wx.login()`

2. **openid 是用户唯一标识**：
   - 同一个微信账号，openid 是固定的
   - 不同小程序，openid 不同
   - 可以用于区分不同用户

3. **session_key 需要保密**：
   - session_key 不应该返回给前端
   - 应该保存在后端
   - 用于数据加密解密

## 获取用户昵称和头像（可选）

如果需要获取用户昵称和头像，可以：

1. **调用 `wx.getUserProfile()`**（需要用户授权）
2. **或者使用后端接口**（如果后端已保存用户信息）

但这不是必须的，openid 已经可以唯一标识用户。
