# 登录系统使用说明

## 🎯 系统概述

本小程序采用**登录后使用**的机制，确保所有用户操作都有明确的身份标识，提供更好的权限管理和用户体验。

## 🔐 登录机制

### 为什么需要登录？

1. **身份识别**：确保每个用户都有唯一标识（userId）
2. **权限管理**：区分普通用户和管理员权限
3. **数据隔离**：购物车、订单与用户关联
4. **功能保护**：防止未授权访问敏感功能

### 哪些功能需要登录？

#### 必须登录的功能
- ✅ 添加到购物车
- ✅ 查看购物车
- ✅ 创建订单
- ✅ 查看订单列表
- ✅ 邀请下单（分享购物车）
- ✅ 生成个人二维码
- ✅ 管理员功能（如果有权限）

#### 无需登录的功能
- ✅ 浏览菜谱
- ✅ 搜索菜谱
- ✅ 查看菜谱详情
- ✅ 切换厨房
- ✅ 查看店铺设置

## 📱 登录流程

### 首次使用

```
1. 【打开小程序】
   - 进入主页
   - 看到底部提示："点击右下角「我的」登录后使用完整功能"
   
2. 【点击「我的」】
   - 进入个人中心
   - 看到「未登录」状态
   - 弹出提示："欢迎使用，登录后可使用完整功能"
   
3. 【点击登录】
   - 点击「立即登录」或「点击登录」
   - 授权获取微信信息
   - 系统生成唯一 userId
   
4. 【登录成功】
   - 显示头像和昵称
   - 可以使用所有功能
   - 如果是首位用户，自动成为管理员
```

### 操作触发登录

```
【场景】：未登录用户点击「添加到购物车」

1. 点击加号按钮
2. 弹出提示："需要登录 - 请先登录后再进行操作"
3. 点击「去登录」
4. 授权登录
5. 登录成功后自动执行刚才的操作
6. 商品成功加入购物车
```

## 🎨 界面提示

### 主页提示

**未登录状态**：
```
┌─────────────────────────────┐
│  🏠 我的小店                │
│                             │
│  ┌─────────────────────┐    │
│  │ 📌 点击右下角「我的」│    │
│  │ 登录后使用完整功能   │    │ ← 动画提示条
│  └─────────────────────┘    │
│                             │
│  [菜谱列表...]              │
└─────────────────────────────┘
```

**已登录状态**：
```
┌─────────────────────────────┐
│  🏠 我的小店                │
│                             │
│  [菜谱列表...]              │ ← 无提示，正常使用
└─────────────────────────────┘
```

### 个人中心页面

**未登录**：
```
┌─────────────────────────┐
│ 👤 未登录               │
│    [点击登录]           │ ← 点击此处登录
└─────────────────────────┘
```

**已登录**：
```
┌─────────────────────────┐
│ 👤 张三                 │
│    欢迎使用电子菜单      │
│    [👑 管理员]          │ ← (如果是管理员)
└─────────────────────────┘
```

### 弹窗提示

**操作时未登录**：
```
┌──────────────────┐
│   需要登录        │
│                  │
│ 请先登录后再进行  │
│ 操作             │
│                  │
│ [取消] [去登录]  │
└──────────────────┘
```

**首次进入个人中心**：
```
┌──────────────────┐
│   欢迎使用        │
│                  │
│ 登录后可使用完整  │
│ 功能             │
│                  │
│ [稍后] [立即登录]│
└──────────────────┘
```

## 🔄 登录后的变化

### 功能解锁

**未登录时**：
```
- 点击「+」加入购物车 → 提示登录
- 点击购物车图标 → 提示登录
- 点击「邀请下单」 → 提示登录
- 查看「我的二维码」 → 提示登录
- 查看订单列表 → 提示登录
```

**登录后**：
```
- 点击「+」加入购物车 → ✅ 成功添加
- 点击购物车图标 → ✅ 进入购物车页面
- 点击「邀请下单」 → ✅ 生成分享链接
- 查看「我的二维码」 → ✅ 显示专属二维码
- 查看订单列表 → ✅ 显示我的订单
```

### 用户信息

登录后获得：
```
{
  userId: "user_1705555555555_abc123",  // 唯一ID
  nickName: "张三",                      // 微信昵称
  avatarUrl: "https://...",            // 头像地址
  code: "xxx",                         // 登录凭证
  loginTime: "2024-01-18T10:30:00"     // 登录时间
}
```

## 💡 常见场景

### 场景1：首次使用小程序

```
操作流程：
1. 打开小程序
2. 浏览菜谱（无需登录）
3. 看到喜欢的菜
4. 点击「+」添加
5. 提示需要登录
6. 点击「去登录」
7. 授权登录
8. 自动添加到购物车
9. 继续选择其他菜品
```

### 场景2：想要下单

```
操作流程：
1. 选好菜品
2. 点击购物车图标
3. 如果未登录 → 提示登录
4. 登录后 → 进入购物车
5. 调整数量
6. 点击「去下单」
7. 填写备注
8. 确认下单
```

### 场景3：查看历史订单

```
操作流程：
1. 点击底部「订单」标签
2. 如果未登录 → 提示登录
3. 登录后 → 显示订单列表
4. 查看订单详情
```

### 场景4：成为管理员

```
操作流程：
1. 登录账号
2. 进入「我的」→「我的二维码」
3. 展示给现有管理员
4. 管理员扫码添加
5. 获得管理员权限
6. 可以管理菜谱、分类、订单
```

## ⚠️ 重要注意事项

### 1. 登录状态持久化

- ✅ 登录一次，长期有效
- ✅ 关闭小程序不会退出
- ✅ userId 本地存储
- ❌ 清除缓存会退出登录

### 2. 更换设备

```
情况：在新设备上使用
结果：需要重新登录
原因：userId 存储在本地
解决：登录后生成新 userId
```

### 3. 权限继承

```
首次登录：
- 默认为普通用户
- 如果是首位用户，自动成为管理员

再次登录：
- 如果 userId 未变，权限保留
- 如果 userId 改变，需要重新添加为管理员
```

### 4. 数据关联

```
登录后的数据：
- ✅ 购物车：关联到用户
- ✅ 订单：记录创建者
- ✅ 管理员：基于 userId 验证

未登录的限制：
- ❌ 无法创建购物车
- ❌ 无法下单
- ❌ 无法查看订单
```

## 🔧 技术细节

### userId 生成

```javascript
// 格式
userId = 'user_' + 时间戳 + '_' + 随机字符串

// 示例
user_1705555555555_abc123xyz

// 特点
- 唯一性：每次生成都不同
- 持久性：本地存储，长期有效
- 不可变：生成后不会改变
```

### 登录检查

```javascript
// 检查是否已登录
checkLogin() {
  const userInfo = app.globalData.userInfo || 
                   wx.getStorageSync('userInfo');
  return !!(userInfo && userInfo.userId);
}

// 要求登录
requireLogin(callback) {
  if (已登录) {
    执行 callback
  } else {
    提示登录 → 登录成功 → 执行 callback
  }
}
```

### 自动登录流程

```
1. 用户点击需要登录的功能
2. 系统检测到未登录
3. 弹出登录提示
4. 用户确认登录
5. 调用 wx.login 获取 code
6. 调用 wx.getUserProfile 获取信息
7. 生成 userId
8. 保存到 globalData 和 Storage
9. 自动执行原操作
```

## 📊 登录状态流转

```
未登录
  ↓ 授权登录
已登录（普通用户）
  ↓ 被添加为管理员
已登录（管理员）
  ↓ 退出登录
未登录
```

## 💡 使用技巧

### 技巧1：提前登录

```
建议：打开小程序后先登录
优势：
- 避免操作中断
- 流畅的使用体验
- 立即使用所有功能
```

### 技巧2：保持登录

```
方法：不要清除小程序数据
好处：
- 无需重复登录
- 保留用户身份
- 保持管理员权限
```

### 技巧3：多设备使用

```
注意：每台设备需单独登录
原因：userId 是设备本地生成的
建议：
- 每台设备都登录一次
- 管理员需要在每台设备上重新添加
```

## ❓ 常见问题

### Q1: 为什么需要登录才能使用？

**答案**：为了更好的用户体验和权限管理。
- 确保每个用户有唯一标识
- 区分普通用户和管理员
- 保护用户数据和隐私
- 实现更完善的功能

### Q2: 登录后会获取哪些信息？

**答案**：只获取基本信息。
- 微信昵称
- 微信头像
- 生成唯一 userId
- 登录时间
- **不会**获取手机号等敏感信息

### Q3: 登录状态会过期吗？

**答案**：不会主动过期。
- 登录后长期有效
- 除非手动退出
- 除非清除小程序数据
- 除非卸载小程序

### Q4: 更换手机后需要重新登录吗？

**答案**：是的。
- 新设备上 userId 会重新生成
- 需要重新登录
- 如果之前是管理员，需要重新添加

### Q5: 可以不登录使用吗？

**答案**：部分功能可以。
- ✅ 浏览菜谱：可以
- ✅ 搜索：可以
- ✅ 查看详情：可以
- ❌ 添加购物车：需要登录
- ❌ 下单：需要登录
- ❌ 查看订单：需要登录

### Q6: 登录失败怎么办？

**答案**：尝试以下方法。
1. 检查网络连接
2. 重启小程序
3. 清除缓存后重试
4. 更新微信到最新版本
5. 如果仍失败，联系技术支持

## 🎉 总结

登录系统提供：

- ✅ **安全可靠**：唯一用户标识
- ✅ **便捷快速**：一键授权登录
- ✅ **长期有效**：登录后持久保存
- ✅ **权限清晰**：区分普通用户和管理员
- ✅ **流畅体验**：操作中自动提示登录
- ✅ **数据保护**：关联用户身份

建议所有用户在首次使用时就完成登录，以获得最佳使用体验！
