# 登录故障排查指南

## 🔍 常见登录失败原因

### 1. 用户取消授权
**现象**：点击"去登录"后，弹出授权窗口，用户点击了"拒绝"或关闭窗口

**提示信息**：
```
您取消了授权
```

**解决方法**：
- 重新点击登录
- 在授权窗口中点击"允许"
- 确保同意获取用户信息

---

### 2. 网络问题
**现象**：点击"去登录"后长时间无响应，或提示登录失败

**提示信息**：
```
登录失败，请检查网络
```

**解决方法**：
1. 检查手机网络连接
2. 切换到Wi-Fi或移动数据
3. 重启微信
4. 重试登录

---

### 3. 微信版本过旧
**现象**：无法弹出授权窗口，或提示不支持

**解决方法**：
1. 更新微信到最新版本
2. 重启微信
3. 重新打开小程序

---

### 4. 小程序权限被禁用
**现象**：始终无法授权

**解决方法**：
1. 打开微信：我 → 设置 → 隐私与安全
2. 找到"授权管理"
3. 找到本小程序
4. 重新授权用户信息

---

### 5. 缓存问题
**现象**：反复登录失败

**解决方法**：
1. 关闭小程序
2. 微信：我 → 设置 → 通用 → 存储空间
3. 清理小程序缓存
4. 重新打开小程序

---

## 🛠️ 详细排查步骤

### 步骤1：检查网络
```
1. 打开手机设置
2. 检查Wi-Fi或移动数据是否开启
3. 尝试访问其他小程序或网页
4. 确认网络正常
```

### 步骤2：检查微信版本
```
1. 打开微信
2. 点击：我 → 设置 → 关于微信
3. 查看版本号
4. 如果不是最新版本，点击"版本更新"
```

### 步骤3：检查授权状态
```
1. 微信：我 → 设置 → 隐私与安全
2. 点击"授权管理"
3. 找到本小程序
4. 查看是否有"用户信息"授权
5. 如果被禁用，重新授权
```

### 步骤4：清除缓存重试
```
1. 关闭小程序（上滑退出）
2. 微信：我 → 设置 → 通用 → 存储空间
3. 点击"管理"
4. 找到本小程序，点击"删除"
5. 重新打开小程序
```

### 步骤5：重启微信
```
1. 完全退出微信（双击Home键或手势，上滑关闭）
2. 重新打开微信
3. 重新打开小程序
4. 尝试登录
```

---

## 📱 按错误信息排查

### "您取消了授权"
```
原因：用户点击了授权窗口的"拒绝"按钮

解决：
1. 重新点击"去登录"
2. 在弹出的授权窗口中点击"允许"
3. 完成授权
```

### "登录失败，请检查网络"
```
原因：网络连接不稳定或无网络

解决：
1. 检查手机网络设置
2. 切换到稳定的网络环境
3. 重新尝试登录
```

### "登录失败，请重试"
```
原因：未知错误或系统异常

解决：
1. 稍等片刻后重试
2. 重启小程序
3. 清除缓存后重试
4. 更新微信版本
```

---

## 💡 登录最佳实践

### 推荐流程
```
1. 首次打开小程序
2. 看到"点击右下角「我的」登录"提示
3. 点击底部"我的"标签
4. 点击"点击登录"按钮
5. 弹出授权窗口
6. 仔细阅读授权说明
7. 点击"允许"授权
8. 等待登录成功提示
9. 开始使用所有功能
```

### 注意事项
- ✅ 确保网络连接稳定
- ✅ 使用最新版本微信
- ✅ 在授权窗口中点击"允许"
- ✅ 耐心等待登录完成
- ❌ 不要在登录中关闭小程序
- ❌ 不要频繁点击登录按钮

---

## 🔧 开发者调试

### 查看登录日志
打开微信开发者工具控制台，查看日志：

```javascript
// 正常登录流程
开始获取用户信息...
wx.login 成功，code: xxx
wx.getUserProfile 成功
生成新的 userId: user_xxx
用户信息已保存: {...}
登录成功: {...}

// 登录失败
开始获取用户信息...
wx.login 成功，code: xxx
wx.getUserProfile 失败: {errMsg: "getUserProfile:fail cancel"}
登录失败详情: {errMsg: "getUserProfile:fail cancel"}
```

### 常见错误码
```
getUserProfile:fail cancel
- 用户取消授权

getUserProfile:fail auth deny
- 用户拒绝授权

getUserProfile:fail api scope is not declared in the privacy agreement
- 隐私协议未配置

login:fail
- 微信登录失败，网络问题
```

---

## 📞 联系支持

如果按照以上步骤仍无法解决问题，可以：

1. **截图错误信息**
   - 登录失败的弹窗
   - 控制台的错误日志

2. **记录操作步骤**
   - 什么时候出现的问题
   - 做了什么操作
   - 是否第一次登录

3. **提供环境信息**
   - 微信版本
   - 手机型号和系统版本
   - 网络环境（Wi-Fi/4G/5G）

4. **联系开发者**
   - 通过小程序反馈入口
   - 或其他指定渠道

---

## ✅ 登录成功标志

成功登录后，您会看到：

1. **提示信息**
   ```
   ✅ 登录成功
   ```

2. **个人中心变化**
   ```
   之前：👤 未登录
   之后：👤 您的昵称 + 头像
   ```

3. **功能解锁**
   ```
   - 可以添加到购物车
   - 可以查看购物车
   - 可以下单
   - 可以查看订单
   ```

4. **主页变化**
   ```
   - 登录提示条消失
   - 所有功能正常使用
   ```

---

## 🎯 预防措施

### 保持登录状态
- ✅ 不要频繁清理微信缓存
- ✅ 不要在微信设置中禁用小程序授权
- ✅ 保持微信版本更新

### 快速恢复
如果意外退出登录：
1. 点击"我的"
2. 点击"点击登录"
3. 重新授权
4. 如果之前是管理员，权限会自动恢复（如果userId未变）

---

## 📊 登录状态检查

### 如何确认已登录？

**方法1：查看个人中心**
```
我的 → 显示头像和昵称 = 已登录
我的 → 显示"未登录" = 未登录
```

**方法2：尝试添加购物车**
```
点击菜品的"+"按钮
- 直接添加成功 = 已登录
- 提示需要登录 = 未登录
```

**方法3：查看主页提示**
```
主页底部有"点击登录"提示 = 未登录
主页无提示 = 已登录
```

---

## 🎉 成功案例

### 案例1：网络问题导致失败
```
问题：点击登录后显示"登录失败，请检查网络"
原因：使用的是弱Wi-Fi信号
解决：切换到4G网络后成功登录
```

### 案例2：取消授权
```
问题：授权窗口点击了"拒绝"
原因：误操作
解决：重新点击"去登录"，点击"允许"授权
```

### 案例3：微信版本过旧
```
问题：无法弹出授权窗口
原因：微信版本是6.x，太旧
解决：更新微信到8.x版本后正常
```

---

希望这份指南能帮助您成功登录！如有其他问题，请参考其他使用说明文档。
