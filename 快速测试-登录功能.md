# 登录功能快速测试指南

## ✅ 已修复的问题

移除了 `setTimeout`，确保 `wx.getUserProfile` 在用户手势上下文中调用。

## 🚀 立即测试（3步）

### 1️⃣ 清除缓存并重新编译
```
1. 微信开发者工具 → 工具 → 清除 → 全部清除
2. 点击"编译"按钮
```

### 2️⃣ 测试登录流程

#### 测试 A：首次打开"我的"页面

**操作步骤**：
1. 点击底部导航"我的"
2. 自动弹出"欢迎使用"对话框
3. 点击"立即登录"按钮

**✅ 预期结果**：
- 弹出微信授权窗口（带用户头像）
- 显示"用于完善用户资料"说明
- 点击"允许"后显示"登录成功"
- 页面显示用户头像和昵称

**❌ 如果失败**：
- 检查控制台是否有 `getUserProfile` 相关错误
- 截图控制台完整日志

#### 测试 B：未登录时添加到购物车

**操作步骤**：
1. 点击底部导航"厨房"（首页）
2. 点击任意菜品的"+"按钮
3. 弹出"需要登录"对话框
4. 点击"去登录"

**✅ 预期结果**：
- 弹出微信授权窗口
- 授权成功后显示"已加入购物车"

#### 测试 C：切换账号

**操作步骤**：
1. 确保已登录状态
2. 进入"我的"页面
3. 点击"更换账号"
4. 点击"确定"

**✅ 预期结果**：
- 弹出微信授权窗口
- 授权成功后显示"账号已切换"

### 3️⃣ 查看控制台日志

**✅ 成功的日志应该包含**：
```
用户确认登录
wx.login 成功，code: xxx
wx.getUserProfile 成功
用户信息已保存: {nickName: "xxx", ...}
登录成功: {nickName: "xxx", ...}
```

**❌ 不应该看到**：
```
wx.getUserProfile 失败: {errMsg: "getUserProfile:fail can only be invoked by user TAP gesture."}
```

## 🐛 问题排查

### 问题 1：仍然显示 "can only be invoked by user TAP gesture"

**可能原因**：
- 文件没有保存
- 缓存没有清除

**解决方法**：
1. 确认 `pages/profile/profile.js` 和 `app.js` 都已保存
2. 再次清除缓存：工具 → 清除 → 全部清除
3. 重启微信开发者工具
4. 重新编译

### 问题 2：授权窗口没有弹出

**可能原因**：
- 已经授权过（缓存数据）
- 模拟器问题

**解决方法**：
1. 清除缓存
2. 检查 Storage 中是否有 `userInfo`
3. 尝试在真机上测试

### 问题 3：授权后没有保存用户信息

**可能原因**：
- Storage 写入失败
- 数据处理错误

**解决方法**：
1. 查看控制台是否有其他错误
2. 检查 `app.globalData.userInfo`
3. 检查 Storage 中的 `userInfo`

## 📊 测试结果记录

### 测试环境
- [ ] 微信开发者工具
- [ ] 真机（iOS）
- [ ] 真机（Android）

### 测试结果

#### 测试 A：首次打开"我的"页面
- [ ] ✅ 通过
- [ ] ❌ 失败，错误信息：____________

#### 测试 B：未登录时添加到购物车
- [ ] ✅ 通过
- [ ] ❌ 失败，错误信息：____________

#### 测试 C：切换账号
- [ ] ✅ 通过
- [ ] ❌ 失败，错误信息：____________

### 控制台日志
```
（粘贴完整的控制台日志）
```

### 截图
（如果有问题，请提供截图）

## 🎯 验证成功的标志

**所有以下条件都满足**：

- [ ] 点击"立即登录"能弹出授权窗口
- [ ] 授权后能看到"登录成功"提示
- [ ] 页面显示用户头像和昵称
- [ ] 控制台没有 `getUserProfile` 相关错误
- [ ] 所有需要登录的功能都正常工作

## 💡 关键修复点

### 修复前 ❌
```javascript
setTimeout(() => {
  wx.showModal({
    success: (res) => {
      this.getUserInfo(); // 失败
    }
  });
}, 500);
```

### 修复后 ✅
```javascript
wx.nextTick(() => {
  wx.showModal({
    success: (res) => {
      this.getUserInfo(); // 成功
    }
  });
});
```

## 📞 需要帮助？

如果测试后仍然有问题，请提供：

1. **完整的控制台日志**（从点击登录开始）
2. **错误信息截图**
3. **测试环境**（开发者工具版本、操作系统）
4. **操作步骤**（具体哪一步失败）

---

**修复时间**：2026-01-18  
**修复方法**：移除 setTimeout，使用 wx.nextTick  
**测试状态**：待验证 ⏳
